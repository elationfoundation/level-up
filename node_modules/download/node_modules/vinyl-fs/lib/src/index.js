'use strict';

var assign = require('object-assign');
var through2 = require('through2');
var gs = require('glob-stream');
var File = require('vinyl');
var duplexify = require('duplexify');
var merge = require('merge-stream');
var sourcemaps = require('gulp-sourcemaps');
var filterSince = require('../filterSince');
var isValidGlob = require('is-valid-glob');

var getContents = require('./getContents');
var resolveSymlinks = require('./resolveSymlinks');

function createFile(globFile, enc, cb) {
  cb(null, new File(globFile));
}

function src(glob, opt) {
  var options = assign({
    read: true,
    buffer: true,
    stripBOM: true,
    sourcemaps: false,
    passthrough: false,
    followSymlinks: true,
  }, opt);

<<<<<<< HEAD
  // Don't pass `read` option on to through2
  var read = options.read !== false;
  options.read = undefined;

=======
>>>>>>> 16a22f1a2827e4eddfc089d7e2423b046879a4ce
  var inputPass;

  if (!isValidGlob(glob)) {
    throw new Error('Invalid glob argument: ' + glob);
  }

  var globStream = gs.create(glob, options);

  var outputStream = globStream
    .pipe(resolveSymlinks(options))
<<<<<<< HEAD
    .pipe(through2.obj(options, createFile));
=======
    .pipe(through2.obj(opt, createFile));
>>>>>>> 16a22f1a2827e4eddfc089d7e2423b046879a4ce

  if (options.since != null) {
    outputStream = outputStream
      .pipe(filterSince(options.since));
  }

<<<<<<< HEAD
  if (read) {
=======
  if (options.read !== false) {
>>>>>>> 16a22f1a2827e4eddfc089d7e2423b046879a4ce
    outputStream = outputStream
      .pipe(getContents(options));
  }

  if (options.passthrough === true) {
<<<<<<< HEAD
    inputPass = through2.obj(options);
=======
    inputPass = through2.obj(opt);
>>>>>>> 16a22f1a2827e4eddfc089d7e2423b046879a4ce
    outputStream = duplexify.obj(inputPass, merge(outputStream, inputPass));
  }
  if (options.sourcemaps === true) {
    outputStream = outputStream
      .pipe(sourcemaps.init({ loadMaps: true }));
  }
  globStream.on('error', outputStream.emit.bind(outputStream, 'error'));
  return outputStream;
}

module.exports = src;
